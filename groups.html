<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Bloc-Note</title>
    <meta charset="utf-8">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!--Let browser know website is optimized for mobile-->
    <link rel="stylesheet" href="css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>

  <body class="grey lighten-4">
    <!-- MENU -->
    <header>
        <nav class="white top-nav">
            <div class="container">
                <div class="nav-wrapper">
                <div class="row">
                    <div class="col s12 m12 offset-m1">
                        <div class="input-field col m5 offset-m1 recherche">
                            <input id="recherche" type="text" placeholder="Recherche" onkeyup="search()" class="valide z-depth-3">
                        </div>
                        <div class="col m3">
                            <a href="user.html" class="flow-text black-text prenom center-align">Vasyuk Mikhail</a>
                        </div>
                        <div class="col m1">
                           <a id="disconnection" class="waves-effect waves-light btn blue z-depth-2">Déconnexion</a>
                       </div>
                        <div class="col m1">
                            <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons black-text center-align">menu</i></a>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </nav>
    <ul id="slide-out" class="sidenav sidenav-fixed">
    <li class="noHover">
        <div class="user-view menu-img">
            <div class="background">
                <img id="logo" class="logo-menu" src="img/logo.png">
            </div>
        </div>
    </li>
    <hr>
    <li class="liMenu"><a href="notes.html"><i class="material-icons">event_note</i>Note</a></li>
    <li class="activeMenu liMenu"><a href="#!"><i class="material-icons">group</i>Groupe</a></li>
    </ul>
    </header>
    <!-- End Menu -->
    <div class="container">
      <div class="row" style="margin-top:20px;">
          <div class="col m4 offset-m2" style="margin-top:15px;">
              <a id="ajoutez" href="#modal1" class="waves-effect waves-light btn blue z-depth-2 modal-trigger"><i class="material-icons left">add</i>Ajoutez un groupe</a>
          </div>
      </div>
      <div class="row" id="groups" style="margin-left:150px">
        <div draggable="true" ondrag="dragstart(event,noteId);" class="col s12 m4 ">
          <div class="card white z-depth-3">
            <div class="card-content black-text">
              <span class="card-title titre">Mes notes</span><p>Toutes les notes qui sont assoiciées à votre profil</p>
            </div>
          </div>
        </div>
      </div>
      </div>
      <div id="modal1" class="modal">
          <div class="modal-content">
              <div class="row">
                <h4 class="center-align">Nouveau groupe
                    <i id="closeNewNote" class="material-icons black-text center-align right pointer">close</i>
                </h4>
              </div>
              <form>
                <div class="row">
                  <div class="input-field col s6 m6">
                    <input id="title" type="text" class="validate">
                    <label for="title">Titre</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s11 m11">
                    <textarea id="message" class="materialize-textarea" onkeydown="characteresCount(100)"></textarea>
                    <label for="message">Déscription...</label>
                  </div>
                </div>
              </form>
              <div class="row">
                <div class="col s6 m6">
                  <h5>Membres</h5>
                  <div class="membres_div">
                    Pas de membre pour le moment
                  </div>
                </div>
                <div class="col s6 m6">
                  <h5>Ajouter un membre</h5>
                  <div class="mdl-textfield mdl-js-textfield">
                    <input class="mdl-textfield__input" type="email" id="email_add_membre">
                  </div>
                  <div class="finded_emails">
                  </div>
                </div>
              </div>
              <a id="save_group" class="modal-close waves-effect waves-blue blue btn"><i class="material-icons right">check</i>Enregistrer</a>
          </div>
      </div>
    </div>


    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script type="text/javascript" src="js/mainWindow.js"></script>
    <script type="text/javascript">
    emails = []


    $('#email_add_membre').keyup(function(){
      if (($(this).val().length) > 3 ){
        $.ajax({
          url: "http://localhost:3000/find_user",
          data: 'email=' +  $(this).val(),
          type: 'get',
          success: function(data) {
            if (data && data.length){
              $(".finded_emails").css('display','block')
              for(i = 0; i < data.length; i++){
                email = '<a style="cursor:pointer" onclick="add_user_to_membre(\''+data[i]+'\')">'+data[i]+'</a>'
                $(".finded_emails").html(email)
              }
            }else{
              $(".finded_emails").css('display','none')
            }
          }
        });
      }else{
          $(".finded_emails").css('display','none')
      }
    });

    function add_user_to_membre(email){
      if (emails.length == 0){
        emails.push(email)
        $('.membres_div').html('<a style="display:block;color:black">'+email+'</a>')
      }else{
        emails.forEach(function(item, index, array) {
          if(item == email){
            alert("L'utilisateur est déjà ajouté")
          }else{
            emails.push(email)
            $('.membres_div').append('<a style="display:block;color:black">'+email+'</a>')
          }
        });
      }
        $(".finded_emails").css('display','none')
        $("#email_add_membre").val('')
    }

      document.addEventListener('DOMContentLoaded', function() {
          var elems = document.querySelectorAll('select');
          var instances = M.FormSelect.init(elems);
          var elems2 = document.querySelectorAll('.sidenav');
          var instances2 = M.Sidenav.init(elems2);
          var elems3 = document.getElementById('modal1');
          var instances3 = M.Modal.init(elems3);
          document.getElementById('closeNewNote').onclick = function() {
              M.Modal.getInstance(elems3).close();
          }
        });

        $(document).ready(function(){
          ipc.send('verif_session');
          show_groups()
        })

        $('#disconnection').click(function(){
          ipc.send('destroy_session');
          ipc.send('verif_session');
        })

        function deleteNote(note_id){
          $.ajax({
            url: 'http://localhost:3000/group/delete/'+note_id,
            type: 'delete',
            success: function(data) {
              $('#groups').html('')
              show_groups()
            }
          });
        }

        function show_groups(){
      		$.ajax({
      			url: 'http://localhost:3000/group/show',
      			data: 'user_id='+ipc.sendSync('get_id'),
      			type: 'get',
      			success: function(data) {
      				for(i = 0; i < data.length; i++){
                groupe='<div draggable="true" ondrag="dragstart(event,noteId);" class="col s12 m4 "><div class="card white z-depth-3"><div class="card-content black-text"><span class="card-title titre">'+data[i]['title']+'</span><p>'+data[i]['description']+'</p></div></div></div></div>'
                $('#groups').append(groupe)
                //<span class="right iconNote" onclick="deleteNote('+data[i]['id']+');"><i class="material-icons black-text center-align">close</i></span>
      				}
      			}
      		});
      	}

      	$('#save_group').click(function(){
      		ipc.send('verif_session');
      		$.ajax({
      			url: 'http://localhost:3000/group/create',
      			data: 'user_id='+ipc.sendSync('get_id')+'&title='+ $('#title').val() +'&description='+ $('#message').val()+'&email='+emails,
      			type: 'post',
      			success: function(data) {
      				 $('#groups').html('')
      				 show_groups()
      				 // dialog_create.close();
      				// ipc.send('show_notes');
      				// ipc.send('verif_session');
      			}
      		});
      	})
    </script>
    </body>
